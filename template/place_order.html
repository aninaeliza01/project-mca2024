{% extends "userBase.html" %}

{% block title %}Place Order{% endblock %}

{% block content %}
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


{% if messages %}
    {% for message in messages %}
        <div class="alert" role="alert">
            {{ message }}
        </div>
    {% endfor %}
{% endif %}

<div class="container">
    <div class="heading_container">
        <h2>Place an Order at {{ pump.station_name }}</h2>
        <p>Address: {{ pump.address }}</p>
        <p>Location: {{ pump.location.name }}</p>
        <form method="post" class="order-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="fuel_type">Fuel Type:</label>
                <select name="fuel_type_id" id="fuel_type" class="select-field">
                    <option value="">Select Fuel Type</option>
                    {% for fuel in fuel_types %}
                        <option value="{{ fuel.id }}" data-price="{{ fuel.price }}">{{ fuel.fueltype }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="selected_price">Price:</label>
                <span id="selected_price" class="price-span"></span>
            </div>

            <div class="form-group">
                <label for="quantity">Quantity:</label>
                <select name="quantity" id="quantity" class="select-field">
                    <option value="">Select Quantity</option>
                    <option value="1">1 liter</option>
                    <option value="2">2 liters</option>
                    <option value="3">3 liters</option>
                    <option value="4">4 liters</option>
                </select>
            </div>

            <div class="form-group">
                <label for="payment_method">Payment Method:</label>
                <select name="payment_method" id="payment_method" class="select-field">
                    <option value="">Select Payment Method</option>
                    <option value="Credit Card">Credit Card</option>
                    <option value="Debit Card">Debit Card</option>
                    <option value="COD">COD</option>
                    <option value="PayPal">PayPal</option>
                </select>
            </div>

            <div class="form-group">
                <label for="delivery_point">Delivery Point:</label>
                <input type="text" name="delivery_point" id="delivery_point" class="text-field" readonly>
                <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#mapModal">Choose Location</button>
            </div>
            <input type="hidden" name="lat" id="lat">
            <input type="hidden" name="lng" id="lng">
            <!-- Add an element to display the distance -->
            <div id="distance-info"></div>
            <!-- Add an element to display the delivery amount -->
            <div id="delivery-amount"></div>
            <input type="hidden" name="delivery_amount" id="delivery_amount">

            <button type="submit" id="submit-button" class="submit-button">Place Order</button>
        </form>
    </div>
</div>

<!-- Add a map modal -->
<div class="modal fade" id="mapModal" tabindex="-1" role="dialog" aria-labelledby="mapModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mapModalLabel">Select Location on Map</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="map" style="height: 400px;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" id="confirm-location" class="btn btn-primary">Confirm Location</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

<style>
    
    #map {
        height: 400px;
        width: 100%;
    }


    body {
        font-family: Arial, sans-serif;
        background-color: #f0f0f0;
        margin: 0;
        padding: 0;
    }

    .container {
        max-width: 600px;
        margin: 20px auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .heading_container {
        text-align: center;
        margin-bottom: 20px;
    }
    .order-form {
        /* margin-top: 20px; */
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .form-group {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
    }

    .form-group label {
        flex: 1;
    }

    .select-field,
    .text-field {
        flex: 2;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
        box-sizing: border-box;
        width: 100%;
    }


    .submit-button {
        padding: 12px 24px;
        background-color: #f90;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
        width: 100%;
        display: block;
    }

    .submit-button:hover {
        background-color: #e6801b;
    }
</style>
<!-- Add this script tag to pass the delivery area coordinates to JavaScript -->
<script>
    const deliveryAreaLat = "{{ map_location.delivery_area_lat }}";
    const deliveryAreaLng = "{{ map_location.delivery_area_lng }}";
</script>

<script>
    // Function to calculate haversine distance
    function haversineDistance(lat1, lon1, lat2, lon2) {
        // Convert latitude and longitude from degrees to radians
        const toRadians = (angle) => angle * (Math.PI / 180);
        lat1 = toRadians(lat1);
        lon1 = toRadians(lon1);
        lat2 = toRadians(lat2);
        lon2 = toRadians(lon2);

        // Haversine formula
        const dLat = lat2 - lat1;
        const dLon = lon2 - lon1;
        const a =
            Math.sin(dLat / 2) ** 2 +
            Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon / 2) ** 2;
        const c = 2 * Math.asin(Math.sqrt(a));

        // Radius of the Earth in kilometers (mean value)
        const radiusOfEarth = 6371;

        // Calculate the distance
        const distance = radiusOfEarth * c;

        return distance;
    }

    $(document).ready(function() {
        var map, marker, circle;
        var userLocation;

        // Function to calculate the delivery charge based on distance
        function calculateDeliveryCharge(distance) {
            var fixedCharge = 20; // Fixed delivery charge for the first kilometer
            var deliveryChargePerKm = 10; // Charge for each kilometer beyond the first

            // Additional charge for each kilometer beyond the first
            var additionalCharge = (distance - 1) * deliveryChargePerKm;

            // Ensure the additional charge is not negative
            additionalCharge = Math.max(0, additionalCharge);

            // Total delivery charge
            var totalCharge = fixedCharge + additionalCharge;

            return totalCharge;
        }

        // Function to display the delivery amount
        function displayDeliveryAmount(amount) {
            // Display the delivery amount on the page
            $('#delivery-amount').text('Delivery Amount: â‚¹' + amount.toFixed(2));
        }

        // Initialize map when the modal is shown
        $('#mapModal').on('shown.bs.modal', function(e) {
            if (!map) {
                // Create map
                map = L.map('map').setView([9.0827879, 76.5650678], 15);

                // Add OpenStreetMap tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '&copy; HybridEnergy'
                }).addTo(map);

                // Add a marker to the map
                marker = L.marker([9.0827879, 76.5650678], {
                    draggable: true // Make the marker draggable
                }).addTo(map);

                // Add a circle for delivery area
                circle = L.circle([deliveryAreaLat, deliveryAreaLng], {
                    color: 'green',
                    fillColor: 'green',
                    fillOpacity: 0.2,
                    radius: 5000 // Change radius as needed
                }).addTo(map);
            } else {
                // Reset marker position if it already exists
                marker.setLatLng([9.0827879, 76.5650678]);
                // Reset delivery area circle position
                circle.setLatLng([deliveryAreaLat, deliveryAreaLng]);
            }

            // Listen for click events on the map to update marker position
            map.on('click', function(e) {
                marker.setLatLng(e.latlng);
            });

            // Get user's current location
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setView(userLocation, 15); // Set map view to user's current location
                    marker.setLatLng(userLocation); // Set marker at user's current location

                    // Calculate distance between user location and delivery area
                    var distances = haversineDistance(userLocation.lat, userLocation.lng, deliveryAreaLat, deliveryAreaLng);

                    

                    // Calculate delivery charge
                    var deliveryCharge = calculateDeliveryCharge(distances);

                    
                
        // Confirm location button click event
        $('#confirm-location').on('click', function() {
            if (!userLocation) {
                alert('User location not available.');
                return;
            }

            
            var distance = marker.getLatLng().distanceTo(circle.getLatLng());

            
            if (distance > circle.getRadius()) {
                alert('Delivery not available in this area.');
                // Close the modal
                $('#mapModal').modal('hide');
            } else {
                $('#lat').val(marker.getLatLng().lat);
                $('#lng').val(marker.getLatLng().lng);
                
                $.get('https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=' + userLocation.lat + '&lon=' + userLocation.lng, function(data) {
                    $('#delivery_point').val(data.display_name);
                });
                // Display the distance on the page
                $('#distance-info').text('Distance to delivery location: ' + distances.toFixed(2) + ' km');
                // Display the delivery amount
                displayDeliveryAmount(deliveryCharge);
                // Close the modal
                $('#mapModal').modal('hide');
            }
        });
    }, function(error) {
                    console.error('Error getting user location:', error);
                });
            } 
else {
                console.log('Geolocation is not supported by this browser.');
            }
        });
    });
</script>

<script>
    $('#submit-button').on('click', function() {
        
        var deliveryAmountText = $('#delivery-amount').text();
        var deliveryAmount = parseFloat(deliveryAmountText.replace('Delivery Amount: â‚¹', ''));

        
        $('#delivery_amount').val(deliveryAmount);

        
        $('.order-form').submit();
    });

    $(document).ready(function() {
        $('.order-form').on('submit', function(event) {
            
            event.preventDefault();

            
            const fuelType = document.getElementById('fuel_type');
            const selectedPrice = document.getElementById('selected_price');
            const quantity = document.getElementById('quantity');
            const deliveryPoint = document.getElementById('delivery_point');
            const paymentMethod = document.getElementById('payment_method');

            
            let isValid = true;

            
            function validateField(field, errorMessage) {
                if (field.value.trim() === '') {
                    isValid = false;
                    alert(errorMessage);
                }
            }

            
            validateField(fuelType, 'Please select a fuel type');
            validateField(quantity, 'Please select a quantity');
            validateField(deliveryPoint, 'Please enter a delivery point');
            validateField(paymentMethod, 'Please select a payment method');

            
            if (isValid) {
                this.submit(); 
            }
        });

        $('#fuel_type').on('change', function() {
            const selectedPrice = this.options[this.selectedIndex].getAttribute('data-price');
            $('#selected_price').text(`${selectedPrice} per liter`);
        });
    });
</script>
 
{% endblock content %}
